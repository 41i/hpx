<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title> Finite state machines</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.66.1">
<link rel="start" href="../index.html" title="Chapter 1. Boost.Coroutine">
<link rel="up" href="advanced.html" title=" Advanced concepts">
<link rel="prev" href="symmetric_coroutines.html" title=" Symmetric coroutines">
<link rel="next" href="events.html" title=" Events">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../boost.png"></td>
<td align="center"><a href="../../../index.htm">Home</a></td>
<td align="center"><a href="../libraries.html">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/people/people.htm">People</a></td>
<td align="center"><a href="http://www.boost.org/more/faq.htm">FAQ</a></td>
<td align="center"><a href="../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="symmetric_coroutines.html"><img src="../../../doc/html/images/prev.png" alt="Prev"></a><a accesskey="u" href="advanced.html"><img src="../../../doc/html/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../doc/html/images/home.png" alt="Home"></a><a accesskey="n" href="events.html"><img src="../../../doc/html/images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="coroutine.finite_state_machines"></a> Finite state machines</h3></div></div></div>
<a name="finite_state_machines.introduction"></a><h3>
<a name="id694828"></a>
        Introduction
      </h3>
<p>
        Finite state machines are a model of computation that consist in a set of
        states, a set of input symbols, a function that maps every tuple <tt class="computeroutput"><span class="special">(</span><span class="identifier">input</span><span class="special">,</span> <span class="identifier">state</span><span class="special">)</span></tt> to new state and the actions performed at
        each state. A complete exposition of the concept is beyond the scope of this
        documentation. Here we will show how coroutines are a straightforward implementation
        of this model.
      </p>
<a name="finite_state_machines.sequence_recognizer"></a><h3>
<a name="id694863"></a>
        Sequence recognizer
      </h3>
<p>
        Consider a state machine that implements this behavior:
      </p>
<div class="blockquote"><blockquote class="blockquote">
<p>
          </p>
<p>
            For every input, output '1' if the last three inputs where <tt class="computeroutput"><span class="number">110</span></tt>, <tt class="computeroutput"><span class="number">0</span></tt>
            otherwise .
          </p>
<p>
        </p>
</blockquote></div>
<p>
        In practice it is a sequence recognizer.
      </p>
<p>
        The formal description of this state machine is the following:
      </p>
<div class="variablelist">
<p class="title"><b>States:</b></p>
<dl>
<dt><span class="term">A:</span></dt>
<dd><p>
            if input == <tt class="computeroutput"><span class="number">1</span></tt> then { output
            <tt class="computeroutput"><span class="number">0</span></tt>, state = B} else { output
            <tt class="computeroutput"><span class="number">0</span></tt>, state = A}
          </p></dd>
<dt><span class="term">B:</span></dt>
<dd><p>
            if input == <tt class="computeroutput"><span class="number">1</span></tt> then { output
            <tt class="computeroutput"><span class="number">0</span></tt>, state = C} else { output
            <tt class="computeroutput"><span class="number">0</span></tt>, state = A}
          </p></dd>
<dt><span class="term">C:</span></dt>
<dd><p>
            if input == <tt class="computeroutput"><span class="number">1</span></tt> then { output
            <tt class="computeroutput"><span class="number">0</span></tt>, state = C} else { output
            <tt class="computeroutput"><span class="number">1</span></tt>, state = A}
          </p></dd>
</dl>
</div>
<p>
        The initial state is <tt class="computeroutput"><span class="identifier">A</span></tt>. This
        FSM can be represented by the following Meley model:
      </p>
<p>
        <span class="inlinemediaobject"><img src="../images/meley.png" alt="meley"></span>
      </p>
<p>
        For example, given the input:
      </p>
<pre class="programlisting">
<span class="number">0110100010010001101001000111110010011001</span>
</pre>
<p>
        The output will be:
      </p>
<pre class="programlisting">
<span class="number">0001000000000000010000000000001000000100</span>
</pre>
<p>
        This state machine can be implemented in <tt class="computeroutput"><span class="identifier">C</span><span class="special">++</span></tt> directly from it definition, using a <tt class="computeroutput"><span class="keyword">switch</span></tt> statement inside a stateful function
        object:
      </p>
<a name="fsm1"></a><p>
      </p>
<pre class="programlisting">
<span class="keyword">struct</span> <span class="identifier">fsm</span> <span class="special">{</span>
  <span class="keyword">void</span> <span class="keyword">operator</span><span class="special">()</span> <span class="special">(</span><span class="keyword">char</span> <span class="identifier">input_</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">bool</span> <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">input_</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">;</span>
    <span class="keyword">switch</span><span class="special">(</span><span class="identifier">m_state</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">case</span> <span class="identifier">A</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="string">"A"</span><span class="special">;</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">B</span> <span class="special">:</span> <span class="identifier">C</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">B</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="string">"B"</span><span class="special">;</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">C</span> <span class="special">:</span> <span class="identifier">D</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">C</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="string">"C"</span><span class="special">;</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">B</span> <span class="special">:</span> <span class="identifier">A</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">D</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="string">"D"</span><span class="special">;</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">A</span> <span class="special">:</span> <span class="identifier">C</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="special">};</span>
  <span class="special">}</span>

  <span class="identifier">fsm</span><span class="special">()</span> <span class="special">:</span>
    <span class="identifier">m_state</span><span class="special">(</span><span class="identifier">A</span><span class="special">)</span> <span class="special">{}</span>

  <span class="keyword">enum</span> <span class="identifier">state</span> <span class="special">{</span> <span class="identifier">A</span><span class="special">,</span> <span class="identifier">B</span><span class="special">,</span> <span class="identifier">C</span><span class="special">,</span> <span class="identifier">D</span><span class="special">};</span>
  <span class="identifier">state</span> <span class="identifier">m_state</span><span class="special">;</span>
<span class="special">};</span>
</pre>
<p>
        Each <tt class="computeroutput"><span class="keyword">case</span></tt> block directly implements
        its corresponding state. While the transformation is straightforward, it
        doesn't make the code very readable. The simplicity of the informal description
        is lost. While this code might be acceptable for machine generated and maintained
        <span class="bold"><b>FSM</b></span>, it is does not scale to large finite
        state machines that must be maintained by humans.
      </p>
<p>
        With coroutines the straight forward transformation is:
      </p>
<pre class="programlisting">
<span class="keyword">typedef</span> <span class="identifier">coro</span><span class="special">::</span><a href="../">coroutine</a><span class="special">&lt;</span><span class="keyword">void</span><span class="special">(</span><span class="keyword">char</span><span class="special">)&gt;</span> <span class="identifier">coroutine_type</span><span class="special">;</span>

<span class="keyword">enum</span> <span class="identifier">state</span> <span class="special">{</span> <span class="identifier">A</span><span class="special">,</span> <span class="identifier">B</span><span class="special">,</span> <span class="identifier">C</span><span class="special">};</span>	
<span class="keyword">void</span> <span class="identifier">fsm</span><span class="special">(</span><span class="identifier">coroutine_type</span><span class="special">::</span><a href="../">self</a><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span> <span class="identifier">input_</span><span class="special">)</span> <span class="special">{</span>
  <span class="identifier">state</span> <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">A</span><span class="special">;</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">bool</span> <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">input_</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">;</span>
    <span class="keyword">switch</span><span class="special">(</span><span class="identifier">m_state</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">case</span> <span class="identifier">A</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">input</span><span class="special">?</span> <span class="char">'0'</span> <span class="special">:</span> <span class="char">'0'</span><span class="special">);</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">B</span> <span class="special">:</span> <span class="identifier">A</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">B</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">input</span><span class="special">?</span> <span class="char">'0'</span> <span class="special">:</span> <span class="char">'0'</span><span class="special">);</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">C</span> <span class="special">:</span> <span class="identifier">A</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="keyword">case</span> <span class="identifier">C</span><span class="special">:</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">input</span><span class="special">?</span> <span class="char">'0'</span> <span class="special">:</span> <span class="char">'1'</span><span class="special">);</span>
      <span class="identifier">m_state</span> <span class="special">=</span> <span class="identifier">input</span><span class="special">?</span> <span class="identifier">C</span> <span class="special">:</span> <span class="identifier">A</span><span class="special">;</span>
      <span class="keyword">break</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">input_</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
  <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
        We haven't gained much with this transformation. We have simply done moved
        the (implicit( external loop inside the fsm and applied a control inversion:
        from its internal point of view, <tt class="computeroutput"><span class="identifier">fsm</span></tt>
        is not longer called for each input, but calls the outside for inputs (using
        <tt class="computeroutput"><a href="../">yield</a><span class="special">()</span></tt>)
      </p>
<p>
        Let's examine the code more carefully and see if we can do better. The <tt class="computeroutput"><span class="identifier">m_state</span></tt> variable and its assignments are
        just carefully concealed <tt class="computeroutput"><span class="keyword">goto</span></tt>
        statements:
      </p>
<pre class="programlisting">
<span class="keyword">void</span> <span class="identifier">fsm_goto</span><span class="special">(</span><span class="identifier">coroutine_type</span><span class="special">::</span><a href="../">self</a><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span> <span class="identifier">input</span><span class="special">)</span> <span class="special">{</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">{</span>
  <span class="identifier">A</span><span class="special">:</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">input</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">B</span><span class="special">;</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">A</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="identifier">B</span><span class="special">:</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">input</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">C</span><span class="special">;</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">A</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="identifier">C</span><span class="special">:</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">input</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">C</span><span class="special">;</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'1'</span><span class="special">;</span>
      <span class="identifier">input</span> <span class="special">=</span> <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
      <span class="keyword">goto</span> <span class="identifier">A</span><span class="special">;</span>
    <span class="special">}</span>
  <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
        <tt class="computeroutput"><span class="identifier">fsm_goto</span></tt> has lost the state
        variable <tt class="computeroutput"><span class="identifier">m_state</span></tt>. The current
        state of the <span class="bold"><b>FSM</b></span> is stored in the instruction
        pointer and need not to be managed explicitly. On the other hand the control
        flow of the code has become explicit and arguably more readable. Then again,
        calling readable a code full of <tt class="computeroutput"><span class="keyword">goto</span></tt>s
        might be a stretch. Let's complete the opera and do the final transformation:
      </p>
<a name="fsm_structured"></a><p>
      </p>
<pre class="programlisting">
<span class="keyword">void</span> <span class="identifier">fsm_structured</span><span class="special">(</span><span class="identifier">coroutine_type</span><span class="special">::</span><a href="../">self</a><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span><span class="special">)</span> <span class="special">{</span>
 <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">{</span>
   <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><a href="../">result</a><span class="special">()</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
     <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
     <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
     <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><a href="../">result</a><span class="special">()</span> <span class="special">!=</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
       <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
       <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
       <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><a href="../">result</a><span class="special">()</span> <span class="special">==</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
         <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'1'</span><span class="special">;</span>
         <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
       <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
         <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
         <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
       <span class="special">}</span>
     <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
       <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
       <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
     <span class="special">}</span>
   <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span> 
     <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
     <span class="identifier">self</span><span class="special">.</span><a href="../">yield</a><span class="special">();</span>
   <span class="special">}</span>
 <span class="special">}</span>
<span class="special">}</span>
</pre>
<p>
        We used <tt class="computeroutput"><a href="../">result</a><span class="special">()</span></tt>. The sequence of <tt class="computeroutput"><span class="keyword">if</span></tt>s
        represent exactly the informal requirement of matching the sequence <tt class="computeroutput"><span class="number">110</span></tt>.
      </p>
<p>
        Whether the above <span class="bold"><b>FSM</b></span> implementation is
        more readable of the <a href="finite_state_machines.html#fsm1">first implementation</a> is
        arguable. But it is easier to generalize it. The repetition of <tt class="computeroutput"><span class="keyword">if</span></tt> statements is a strong hint that the code
        should be refactored:
      </p>
<pre class="programlisting">
<span class="keyword">typedef</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">(</span><span class="identifier">coroutine_type2</span><span class="special">::</span><span class="identifier">self</span><span class="special">&amp;)&gt;</span> <span class="identifier">action_type</span><span class="special">;</span>

<span class="keyword">typedef</span> <span class="identifier">coroutine</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">(</span><span class="keyword">char</span><span class="special">)&gt;</span> <span class="identifier">coroutine_type2</span><span class="special">;</span>

<span class="keyword">void</span> <span class="identifier">terminator</span><span class="special">(</span><span class="identifier">coroutine_type2</span><span class="special">::</span><span class="identifier">self</span><span class="special">&amp;)</span> <span class="special">{}</span>

<span class="keyword">void</span> <span class="identifier">match</span><span class="special">(</span><span class="identifier">coroutine_type2</span><span class="special">::</span><span class="identifier">self</span><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span> <span class="identifier">match</span><span class="special">,</span> <span class="keyword">char</span> <span class="identifier">out1</span><span class="special">,</span> <span class="keyword">char</span> <span class="identifier">out2</span> <span class="special">,</span> <span class="identifier">action_type</span> <span class="identifier">act</span><span class="special">,</span> <span class="identifier">action_type</span> <span class="identifier">act2</span><span class="special">)</span> <span class="special">{</span>
  <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">match</span><span class="special">)</span> <span class="special">{</span>
    <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">(</span><span class="identifier">out1</span><span class="special">);</span>
    <span class="identifier">act</span><span class="special">(</span><span class="identifier">self</span><span class="special">);</span>
  <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
    <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">(</span><span class="identifier">out2</span><span class="special">);</span>
    <span class="identifier">act2</span><span class="special">(</span><span class="identifier">self</span><span class="special">);</span>
  <span class="special">}</span>
<span class="special">}</span>

<span class="keyword">char</span> <span class="identifier">fsm_match</span><span class="special">(</span><span class="identifier">coroutine_type2</span><span class="special">::</span><span class="identifier">self</span><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span><span class="special">)</span> <span class="special">{</span>
  <span class="identifier">action_type</span> <span class="identifier">s3</span> <span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">match</span><span class="special">,</span> <span class="identifier">_1</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="char">'1'</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="identifier">terminator</span><span class="special">,</span> <span class="identifier">terminator</span><span class="special">));</span>
  <span class="identifier">action_type</span> <span class="identifier">s2</span> <span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">match</span><span class="special">,</span> <span class="identifier">_1</span><span class="special">,</span> <span class="char">'1'</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="identifier">s3</span><span class="special">,</span> <span class="identifier">terminator</span><span class="special">));</span>
  <span class="identifier">action_type</span> <span class="identifier">s1</span> <span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">match</span><span class="special">,</span> <span class="identifier">_1</span><span class="special">,</span> <span class="char">'1'</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="char">'0'</span><span class="special">,</span> <span class="identifier">s2</span><span class="special">,</span> <span class="identifier">terminator</span><span class="special">));</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">{</span>
    <span class="identifier">s1</span><span class="special">(</span><span class="identifier">self</span><span class="special">);</span>
  <span class="special">}</span> 
<span class="special">}</span>
</pre>
<div class="sidebar"><p>
        <span class="inlinemediaobject"><img src="../images/note.png" alt="note"></span> We use <tt class="computeroutput"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">function</span></tt>
        because if <tt class="computeroutput"><span class="identifier">match</span></tt> where templated
        on the action type, the compiler wouldn't know which <tt class="computeroutput"><span class="identifier">match</span></tt>
        to pass to <tt class="computeroutput"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">bind</span></tt>. There are more efficient solutions,
        but this is the most compact and simple.
      </p></div>
<p>
        <tt class="computeroutput"><span class="identifier">match</span></tt> chooses what symbol
        to yield and what action to follow by checking if the last parameter to the
        coroutine is equal to the symbol to be matched.
      </p>
<p>
        The <a href="finite_state_machines.html#fsm_structured">structured <span class="bold"><b>FSM</b></span></a>
        can be extended to match more complex patterns. For example a matcher for
        the regular expression <tt class="computeroutput"><span class="special">(</span><span class="number">01</span><span class="special">+</span><span class="number">010</span><span class="special">)</span></tt>
        can be written as:
      </p>
<pre class="programlisting">
<span class="keyword">void</span> <span class="identifier">fsm_regexp</span><span class="special">(</span><span class="identifier">coroutine_type</span><span class="special">::</span><span class="identifier">self</span><span class="special">&amp;</span> <span class="identifier">self</span><span class="special">,</span> <span class="keyword">char</span><span class="special">)</span> <span class="special">{</span>
  <span class="keyword">while</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
      <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="char">'1'</span><span class="special">)</span> <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
        <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
        <span class="keyword">while</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="char">'1'</span><span class="special">)</span> <span class="special">{</span>
          <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
          <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
        <span class="special">}</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="char">'0'</span><span class="special">;</span>
        <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
        <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="char">'1'</span><span class="special">)</span> <span class="special">{</span>
          <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
          <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
          <span class="keyword">if</span><span class="special">(</span><span class="identifier">self</span><span class="special">.</span><span class="identifier">result</span><span class="special">()</span> <span class="special">==</span> <span class="char">'0'</span><span class="special">)</span> <span class="special">{</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'1'</span><span class="special">;</span>
            <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
          <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="char">'0'</span><span class="special">;</span>
            <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
          <span class="special">}</span> 
        <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
          <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="char">'0'</span><span class="special">;</span>
          <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
        <span class="special">}</span>
      <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="char">'0'</span><span class="special">;</span>
        <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
      <span class="special">}</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span><span class="char">'0'</span><span class="special">;</span>
      <span class="identifier">self</span><span class="special">.</span><span class="identifier">yield</span><span class="special">();</span>
    <span class="special">}</span>
  <span class="special">}</span> 
<span class="special">}</span>
</pre>
<p>
        Generalizing this example is left as an exercise for the reader.
      </p>
<p>
        Notice that the above <span class="bold"><b>FSM</b></span> will fail to match
        the last six digits of this pattern:
      </p>
<pre class="programlisting">
<span class="number">011011010</span>
</pre>
<p>
        This because when it sees the fourth <tt class="computeroutput"><span class="number">1</span></tt>,
        while it was expecting a <tt class="computeroutput"><span class="number">0</span></tt>, the
        state machine does not backtrack to match the <tt class="computeroutput"><span class="number">1</span><span class="special">+</span></tt> pattern, but returns to the beginning of
        the pattern and tries to find a <tt class="computeroutput"><span class="number">0</span></tt>.
      </p>
<p>
        It is possible to implement backtracking elegantly with coroutines using
        a goal driven design, but it is beyond the scope of this document. See the
        example <tt class="literal"><a href="../../../../coroutine/example/complex_matcher.cpp" target="_top">complex_matcher.cpp</a></tt>
        for more details.
      </p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright © 2006 Giovanni P. Deretta<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">
        http://www.boost.org/LICENSE_1_0.txt </a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="symmetric_coroutines.html"><img src="../../../doc/html/images/prev.png" alt="Prev"></a><a accesskey="u" href="advanced.html"><img src="../../../doc/html/images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../../../doc/html/images/home.png" alt="Home"></a><a accesskey="n" href="events.html"><img src="../../../doc/html/images/next.png" alt="Next"></a>
</div>
</body>
</html>
